<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Tuya Breaker - Monitor</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 12px;
        background: #f4f6f8;
        color: #222;
      }
      #events {
        border: 1px solid #ddd;
        padding: 8px;
        height: 60vh;
        overflow: auto;
        background: #fff;
      }
      .event {
        margin: 6px 0;
        padding: 6px;
        border-bottom: 1px solid #eee;
      }
      .meta {
        color: #666;
        font-size: 12px;
      }
      button {
        margin: 4px;
      }

      /* cards */
      .cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 12px;
      }
      .card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        padding: 12px;
      }
      .card .hdr {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      .badge {
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        color: #fff;
      }
      .badge.on {
        background: #28a745;
      }
      .badge.off {
        background: #6c757d;
      }
      .card pre {
        background: #f7f9fb;
        padding: 8px;
        border-radius: 6px;
        overflow: auto;
        font-size: 11px; /* JSON aún más pequeño para tarjetas */
      }
      .muted {
        color: #666;
        font-size: 13px;
      }
      .small {
        font-size: 12px;
      }
      .btn {
        background: #007bff;
        color: #fff;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
      }
      .btn.secondary {
        background: #6c757d;
      }
      .controls {
        margin-top: 8px;
      }
      #events pre, #tuyastatus { font-size: 12px; }
    </style>
  </head>
  <body>
    <h1>Tuya Breaker - Monitor</h1>
    <div style="display: flex; gap: 12px; align-items: flex-start">
      <div style="flex: 1">
        <h3>Arduinos</h3>
        <div id="arduinos"></div>
        <h3>Breakers</h3>
        <div id="breakers"></div>
      </div>
      <div
        style="width: 380px; display: flex; flex-direction: column; gap: 12px"
      >
        <div>
          <h3>Eventos (JSON)</h3>
          <div id="events"></div>
        </div>
        <div>
          <h3>Tuya Status (JSON formateado)</h3>
          <div id="tuyastatus" style="border:1px solid #ddd;padding:8px;height:18vh;overflow:auto;background:#fff;white-space:pre-wrap;"></div>
        </div>
        <div>
          <h3>Tarjetas</h3>
          <div id="tarjetas-controls"></div>
        </div>
      </div>
    </div>
    <script>
  let currentModels = { breakers: [], tarjetas: [], arduinos: [] };
      const ws = new WebSocket(
        (location.protocol === "https:" ? "wss://" : "ws://") +
          location.host +
          "/ws"
      );
      const events = document.getElementById("events");
      const tuyastatus = document.getElementById("tuyastatus");

      // logs full JSON objects (existing behavior)
      function logEvent(obj) {
        const el = document.createElement("div");
        el.className = "event";
        el.innerHTML =
          '<div class="meta">' +
          new Date().toLocaleTimeString() +
          "</div><pre>" +
          JSON.stringify(obj, null, 2) +
          "</pre>";
        events.prepend(el);
      }

      async function fetchModels() {
        const res = await fetch("/models");
        const data = await res.json();
        if (editingSaldoBid) {
          // si se está editando, no re-renderizar; solo actualizar modelo en memoria y saldos visibles
          currentModels = data;
          (data.tarjetas||[]).forEach(t=>{
            document.querySelectorAll('[data-tid-saldo="'+t.id+'"]').forEach(el=>{
              el.textContent = (t.saldo===undefined||t.saldo===null)?'—':t.saldo;
            });
          });
        } else {
          renderModels(data);
        }
      }

      function fieldOrDash(v) {
        return v === null || v === undefined || v === "" ? "—" : v;
      }

    let editingSaldoBid = null;

    function renderModels(data) {
  currentModels = data;
        const a = document.getElementById("arduinos");
        const b = document.getElementById("breakers");
        a.innerHTML = "";
        b.innerHTML = "";

        const arduinosWrap = document.createElement("div");
        arduinosWrap.className = "cards";
        (data.arduinos || []).forEach((ad) => {
          const isCharge = !!ad.es_estacion_carga;
          const wps = ad.w_por_segundo !== undefined ? ad.w_por_segundo : '—';
          const lastHtml = ad.last ? '<div class="muted small">Último:<pre style="font-size:12px">'+JSON.stringify(ad.last, null, 2)+'</pre></div>' : '<div class="muted small">Sin datos</div>';
          let chargingHtml = '';
          if(isCharge){
            const sessions = Array.isArray(ad.charging) ? ad.charging : [];
            if(sessions.length>0){
              chargingHtml = '<div class="muted small">Cargando ('+sessions.length+'):</div>'+
                '<ul class="small" style="margin:4px 0 6px 16px; padding:0; list-style:disc">'+
                sessions.map(s=>{
                  const id = (s.uid||'').toString();
                  const since = s.started_ms ? new Date(s.started_ms).toLocaleTimeString() : '—';
                  const w = (s.wps!==undefined && s.wps!==null) ? s.wps : '—';
                  return '<li><strong>'+id+'</strong> desde '+since+' @ '+w+' W/s</li>';
                }).join('')+
                '</ul>';
            } else if(ad.last && (ad.last.nfc || ad.last.uid || ad.last.rfid)){
              chargingHtml = '<div class="muted">Cargando NFC: <strong>' + (ad.last.nfc || ad.last.uid || ad.last.rfid) + '</strong></div>';
            }
          }
          const badge = '<span class="badge ' + (isCharge ? 'on' : 'off') + '">' + (isCharge ? 'Estación de carga' : 'Lector') + '</span>';
          const body =
            '<div class="hdr"><div><strong>' +
            fieldOrDash(ad.id) +
            '</strong><div class="muted small">Arduino</div></div><div>' + badge + '</div></div>' +
            (isCharge ? ('<div class="muted small">W/s: <strong>' + fieldOrDash(wps) + '</strong></div>') : '') +
            chargingHtml +
            "<div>" + lastHtml + "</div>";
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = body;
          arduinosWrap.appendChild(card);
        });
        a.appendChild(arduinosWrap);

        const breakersWrap = document.createElement("div");
        breakersWrap.className = "cards";
        (data.breakers || []).forEach((br) => {
          const tarjeta = (data.tarjetas || []).find(
            (t) => t.id === br.tarjeta
          );
          const estado = br.estado ? "on" : "off";
          const saldo = fieldOrDash(
            br.saldo ?? (tarjeta ? tarjeta.saldo : "—")
          );
          const power = fieldOrDash(br.power);
          const energy = fieldOrDash(br.energy);
          const voltage = fieldOrDash(br.voltage);
          const current = fieldOrDash(br.current);
          const lastCons = fieldOrDash(br.consumption_last_ws);

          const hdr =
            '<div class="hdr"><div><strong>Breaker ' +
            (br.id.substring(0, 8) || "") +
            '</strong><div class="muted small">ID: ' +
            fieldOrDash(br.id) +
            "</div></div>" +
            '<div><span class="badge ' +
            (estado === "on" ? "on" : "off") +
            '">' +
            (estado === "on" ? "ON" : "OFF") +
            "</span></div></div>";

          const body =
              hdr +
              '<div class="muted">' +
              br.nombre +
              "</div><br/>" +
              '<div class="muted">Potencia: <strong>' + power + ' W</strong> &nbsp; Energía: <strong>' + energy + ' kWh</strong><br/>' +
              'Consumo último 1s: <strong>' + lastCons + ' W·s</strong><br/>' +
              'Voltaje: <strong>' + voltage + ' V</strong> &nbsp; Corriente: <strong>' + current + ' A</strong>' +
              "</div>" +
              '<div style="margin-top:8px">' +
              (tarjeta
                ? '<div class="tarjeta-block" style="border-left:3px solid #007bff;padding-left:8px;border-radius:4px;background:#f8fbff;">' +
                    '<div class="muted small">Tarjeta asociada: <strong>' + fieldOrDash(tarjeta.id) + '</strong></div>' +
                    '<div class="muted small">Saldo tarjeta: <strong class="tarjeta-saldo" data-tid-saldo="' + tarjeta.id + '">' + fieldOrDash(tarjeta.saldo) + '</strong></div>' +
                    '<div class="muted small" style="margin-top:6px">Saldo del breaker: <span class="breaker-saldo" data-bid-saldo="' + br.id + '">' + (br.saldo===undefined||br.saldo===null?'—':br.saldo) + '</span> <button class="btn secondary btn-edit-saldo" data-bid="' + br.id + '">Editar</button></div>' +
                  '</div>'
                : '<div class="muted">Sin tarjeta asignada</div>') +
              "</div>" +
              '<div class="controls"><button data-id="' + br.id + '" class="btn">' + (br.estado ? "Apagar" : "Encender") + "</button></div>";

          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = body;
          breakersWrap.appendChild(card);
        });
        b.appendChild(breakersWrap);

        // agregar data-id a cada card para updates incrementales
        document.querySelectorAll('#breakers .card').forEach(card=>{
          const idMatch = card.innerHTML.match(/ID: ([^<]+)/);
          if(idMatch){ card.dataset.bid = idMatch[1]; }
        });

        // wire only toggle buttons (those with data-id) to avoid interfering with edit/save buttons
        document.querySelectorAll("button[data-id]").forEach((btn) => {
          btn.onclick = async (ev) => {
            const id = btn.getAttribute("data-id");
            if(!id) return;
            const res = await fetch(
              "/breakers/" + encodeURIComponent(id) + "/toggle",
              { method: "POST" }
            ).then((r) => r.json());
            logEvent(res);
            fetchModels();
          };
        });

      // Controles para tarjetas: lista read-only en la barra lateral
      const tarjetasDiv = document.getElementById('tarjetas-controls');
      if(tarjetasDiv){
        tarjetasDiv.innerHTML = '';
        (data.tarjetas||[]).forEach(t=>{
          const el = document.createElement('div');
          el.className = 'card';
          el.innerHTML = '<div class="hdr"><div><strong>Tarjeta ' + (t.id||'') + '</strong><div class="muted small">ID tarjeta</div></div></div>'+
            '<div class="muted">Saldo: <strong>' + (t.saldo===undefined||t.saldo===null? '—' : t.saldo) + '</strong></div>';
          tarjetasDiv.appendChild(el);
        });
      }

      // Event delegation para manejar edición/guardado de saldo dentro de los breakers
      const breakersContainer = document.getElementById('breakers');
      breakersContainer.addEventListener('click', async (ev)=>{
        const target = ev.target;
        if(target.matches('.btn-edit-saldo')){
          const bid = target.getAttribute('data-bid');
          editingSaldoBid = bid;
          // mostrar input inline
          const displaySpan = document.querySelector('[data-bid-saldo="'+bid+'"]');
          if(!displaySpan) return;
          const current = displaySpan.textContent.trim();
          const editHtml = '<input type="text" class="input-saldo-edit" data-bid-input="'+bid+'" value="'+(current==='—'?'':current)+'" style="width:100px"/> <button class="btn btn-save-saldo" data-bid-save="'+bid+'">Guardar</button> <button class="btn secondary btn-cancel-saldo" data-bid-cancel="'+bid+'">Cancelar</button>';
          displaySpan.style.display = 'none';
          target.style.display = 'none';
          // insertar contenedor de edición
          let editCont = document.querySelector('.edit-saldo-'+bid);
          if(!editCont){
            editCont = document.createElement('span');
            editCont.className = 'edit-saldo-'+bid;
            target.parentNode.appendChild(editCont);
          }
          editCont.innerHTML = editHtml;
        } else if(target.matches('.btn-save-saldo')){
          const bid = target.getAttribute('data-bid-save');
          const input = document.querySelector('.input-saldo-edit[data-bid-input="'+bid+'"]');
          if(!input) return;
          const val = input.value;
          const br = (currentModels.breakers||[]).find(x=>x.id===bid);
          if(!br || !br.tarjeta){ logEvent({ok:false,error:'breaker sin tarjeta asociada'}); return; }
          const tid = br.tarjeta;
          const res = await fetch('/tarjetas/'+encodeURIComponent(tid)+'/saldo', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({saldo: val})}).then(r=>r.json());
          logEvent(res);
          // limpiar UI (volver a mostrar span) y refrescar modelos
          const displaySpan = document.querySelector('[data-bid-saldo="'+bid+'"]');
          const editCont = document.querySelector('.edit-saldo-'+bid);
          const editBtn = document.querySelector('.btn-edit-saldo[data-bid="'+bid+'"]');
          if(editCont) editCont.innerHTML = '';
          if(displaySpan) { displaySpan.style.display = ''; }
          if(editBtn) { editBtn.style.display = ''; }
          editingSaldoBid = null;
          fetchModels();
        } else if(target.matches('.btn-cancel-saldo')){
          const bid = target.getAttribute('data-bid-cancel');
          const displaySpan = document.querySelector('[data-bid-saldo="'+bid+'"]');
          const editCont = document.querySelector('.edit-saldo-'+bid);
          const editBtn = document.querySelector('.btn-edit-saldo[data-bid="'+bid+'"]');
          if(editCont) editCont.innerHTML = '';
          if(displaySpan) { displaySpan.style.display = ''; }
          if(editBtn) { editBtn.style.display = ''; }
          editingSaldoBid = null;
        }
      });
       }

      function handleEvent(obj) {
        // si es update de breaker, refrescar modelos
        if (obj && obj.type === "breakers:update") {
          const br = currentModels.breakers.find(x=>x.id===obj.id);
          if(br){ br.estado = (obj.state === 'on'); updateBreakerCard(br.id); }
          else { fetchModels(); }
        }
        if (obj && obj.type === "breakers:consumption") {
          const br = currentModels.breakers.find(x=>x.id===obj.id);
            if(br){
              if('power' in obj) br.power = obj.power;
              if('energy' in obj) br.energy = obj.energy;
              if('voltage' in obj) br.voltage = obj.voltage;
              if('current' in obj) br.current = obj.current;
              if('ws' in obj) br.consumption_last_ws = obj.ws;
              updateBreakerCard(br.id);
            }else{
              fetchModels();
            }
        }
        // actualizar tarjetas y arduinos a partir de broadcasts
        if(obj && obj.type === 'tarjetas:update'){
          // actualizar modelo en memoria
          let t = currentModels.tarjetas.find(x=>x.id===obj.id);
          if(t){ Object.assign(t, obj.tarjeta); }
          else {
            (currentModels.tarjetas||[]).push(obj.tarjeta);
          }
          // actualizar DOM in-place para evitar cerrar editores
          document.querySelectorAll('[data-tid-saldo="'+obj.id+'"]').forEach(el=>{
            el.textContent = (obj.tarjeta && (obj.tarjeta.saldo!==undefined && obj.tarjeta.saldo!==null)) ? obj.tarjeta.saldo : '—';
          });
        }
        if(obj && obj.type === 'arduinos:update'){
          const idx = (currentModels.arduinos||[]).findIndex(x=>x.id===obj.id);
          if(idx>=0){ currentModels.arduinos[idx] = obj.arduino || Object.assign({}, currentModels.arduinos[idx], obj); }
          fetchModels();
        }
        if(obj && obj.type === 'models' && obj.data){
          // si estamos editando saldo, no re-renderizar para no cerrar el input
          if(editingSaldoBid){
            // solo actualizar el modelo en memoria
            currentModels = obj.data;
          } else {
            renderModels(obj.data);
          }
        }
      }

      function updateBreakerCard(id){
        const container = document.getElementById('breakers');
        const card = Array.from(container.querySelectorAll('.card')).find(c=>c.dataset.bid===id);
        if(!card){ return; }
        const br = currentModels.breakers.find(x=>x.id===id);
        if(!br){ return; }
        const tarjeta = (currentModels.tarjetas||[]).find(t=>t.id===br.tarjeta);
        const estado = br.estado ? 'on':'off';
        const saldo = (br.saldo ?? (tarjeta? tarjeta.saldo : '—')) ?? '—';
        function fd(v){ return (v===null||v===undefined||v==='')?'—':v; }
        const power = fd(br.power);
        const energy = fd(br.energy);
        const voltage = fd(br.voltage);
        const current = fd(br.current);
        const lastCons = fd(br.consumption_last_ws);
        card.querySelector('.badge').className = 'badge '+(estado==='on'?'on':'off');
        card.querySelector('.badge').textContent = estado==='on'?'ON':'OFF';
        // Reemplazar bloque de métricas (buscar por texto 'Saldo:')
        const metricsRegex = /Saldo:[\s\S]*?<\/div>/;
        card.innerHTML = card.innerHTML.replace(metricsRegex, () => {
          return '<div class="muted">Saldo: <strong>'+saldo+'</strong><br/>'+
            'Potencia: <strong>'+power+' W</strong> &nbsp; Energía: <strong>'+energy+' kWh</strong><br/>'+
            'Consumo último 1s: <strong>'+lastCons+' W·s</strong><br/>'+
            'Voltaje: <strong>'+voltage+' V</strong> &nbsp; Corriente: <strong>'+current+' A</strong>'+
            '</div>';
        });
      }

      // Mostrar y mantener un historial corto de Tuya Status como JSON formateado
      const tuyaLog = [];
      function logTuya(obj){
        try{
          tuyaLog.unshift(obj);
          if(tuyaLog.length>50) tuyaLog.length = 50;
          tuyastatus.textContent = tuyaLog.map(x=>JSON.stringify(x,null,2)).join('\n---\n');
        }catch(e){
          tuyastatus.textContent = String(obj);
        }
      }

      // carga inicial y refresco periódico
      fetchModels();
      setInterval(fetchModels, 5000);
      // Tick de consumo desde el frontend: cada segundo descuenta Ws de la tarjeta asociada
      setInterval(async ()=>{
        try{
          if(!currentModels || !Array.isArray(currentModels.breakers)) return;
          if(editingSaldoBid) return; // no operar durante edición manual
          const elapsed = 1.0; // 1s
          for(const br of (currentModels.breakers||[])){
            if(!br || !br.estado) continue;
            if(!br.tarjeta) continue;
            let power = br.power;
            const v = br.voltage, i = br.current;
            // inferir potencia si falta
            let inferred = null;
            try{
              if(v!=null && i!=null){ inferred = parseFloat(v)*parseFloat(i); }
            }catch{}
            try{
              if(power==null || power===undefined){ power = inferred; }
              else {
                power = parseFloat(power);
                if(!isFinite(power)) power = inferred;
                else {
                  if(inferred!=null && isFinite(inferred)){
                    if(power < 10 && inferred > power*10){ power = power*1000.0; }
                  } else {
                    if(power < 10){ power = power*1000.0; }
                  }
                }
              }
            }catch{ power = inferred; }
            if(power==null || !isFinite(power)){
              continue; // no hay potencia para descontar
            }
            const ws = power * elapsed; // W·s
            // aplicar ajuste negativo a la tarjeta
            try{
              await fetch('/tarjetas/'+encodeURIComponent(br.tarjeta)+'/ajuste', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ delta: -ws })
              });
            }catch{}
            // actualizar UI localmente para sensación de inmediatez
            const t = (currentModels.tarjetas||[]).find(x=>x.id===br.tarjeta);
            if(t && typeof t.saldo === 'number'){
              t.saldo = Math.max(0, Math.round((t.saldo - ws)*1000000)/1000000);
              document.querySelectorAll('[data-tid-saldo="'+br.tarjeta+'"]').forEach(el=>{
                el.textContent = t.saldo;
              });
            }
            br.consumption_last_ws = Math.round(ws*1000000)/1000000;
            updateBreakerCard(br.id);
          }
        }catch(e){ /* silencioso */ }
      }, 1000);
      ws.onopen = () => {
        logEvent({ type: "info", msg: "conectado ws" });
        logTuya({ type: "info", msg: "ws conectado" });
      };
      ws.onmessage = (ev) => {
        try {
          const obj = JSON.parse(ev.data);
          handleEvent(obj);
          logEvent(obj);
          // always mirror a concise tuya-style line so "escucha todo"
          logTuya(obj);
        } catch (e) {
          logEvent({ raw: ev.data });
          logTuya(ev.data);
        }
      };
      ws.onclose = () => {
        logEvent({ type: "info", msg: "ws cerrado" });
        logTuya({ type: "info", msg: "ws cerrado" });
      };
    </script>
  </body>
</html>
